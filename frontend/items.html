<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Analysis | Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- GOLD LUXE THEME --- */
        :root {
            --primary: #ca8a04;       /* Gold Dark */
            --primary-glow: #fde047;  /* Gold Light */
            --secondary: #1f2937;     /* Slate Black */
            --glass: rgba(255, 255, 255, 0.95);
            --border: rgba(202, 138, 4, 0.2); /* Gold Border */
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc; /* Very light gray/white */
            color: #1f2937;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .font-tech { font-family: 'Space Grotesk', sans-serif; }

        /* --- GOLD GRADIANT MESH --- */
        .bg-mesh {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: 
                radial-gradient(at 0% 0%, rgba(253, 224, 71, 0.15) 0, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(202, 138, 4, 0.1) 0, transparent 50%);
            pointer-events: none;
        }

        /* --- PREMIUM CARDS --- */
        .glass-panel {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.4s ease;
        }

        .glass-panel:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            border-color: #fcd34d; /* Light Gold on Hover */
        }

        /* --- ANIMATIONS --- */
        .slide-up { 
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
            opacity: 0; 
            transform: translateY(20px); 
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        @keyframes slideUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            color: transparent !important;
            border-radius: 4px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #ca8a04; }

        .visual-evidence-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid #f0f0f0;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div class="bg-mesh"></div>

    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <div class="flex justify-between items-center mb-8 slide-up">
            <button onclick="history.back()" class="group flex items-center gap-3 px-5 py-2.5 rounded-xl bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-yellow-400 transition-all duration-300">
                <i class="fas fa-arrow-left text-gray-400 group-hover:text-yellow-600 group-hover:-translate-x-1 transition-transform"></i>
                <span class="font-bold text-gray-700 group-hover:text-gray-900">Back</span>
            </button>
            <div class="flex items-center gap-2 px-3 py-1 bg-yellow-50 border border-yellow-200 rounded-full">
                <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-bold text-yellow-700 tracking-wider">LIVE SYSTEM</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-8 space-y-6">
                
                <div class="glass-panel rounded-2xl p-8 relative overflow-hidden slide-up delay-100 bg-gradient-to-br from-white to-yellow-50/50">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
                        <div class="text-center md:text-left">
                            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black text-white mb-3 shadow-md">
                                <i class="fas fa-bolt text-yellow-400 text-xs"></i>
                                <span class="text-xs font-bold uppercase tracking-wider">AI Confidence</span>
                            </div>
                            <h1 class="text-4xl md:text-5xl font-black text-gray-900 tracking-tight mb-2">
                                Match <span class="text-yellow-600">Analysis</span>
                            </h1>
                            <div class="flex items-center justify-center md:justify-start gap-3 text-sm font-medium text-gray-500">
                                <span class="bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">ID: #<span id="displayMatchId" class="skeleton text-gray-800">----</span></span>
                                <span class="text-gray-300">|</span>
                                <span id="displayDate" class="skeleton">Loading Date...</span>
                            </div>
                        </div>

                        <div class="relative group">
                            <div class="absolute inset-0 bg-yellow-400/20 blur-2xl rounded-full opacity-50"></div>
                            <svg class="w-32 h-32 transform -rotate-90 relative z-10 drop-shadow-xl">
                                <circle cx="64" cy="64" r="56" stroke="white" stroke-width="8" fill="white" class="shadow-sm" />
                                <circle cx="64" cy="64" r="56" stroke="#f3f4f6" stroke-width="8" fill="transparent" />
                                <circle id="scoreRing" cx="64" cy="64" r="56" stroke="url(#gradient)" stroke-width="8" stroke-linecap="round" fill="transparent" stroke-dasharray="351" stroke-dashoffset="351" class="transition-all duration-1000 ease-out" />
                                <defs>
                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#eab308" /> <stop offset="100%" stop-color="#ca8a04" /> </linearGradient>
                                </defs>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center z-20">
                                <span id="scoreText" class="text-3xl font-black text-gray-800 tracking-tighter">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="visual-evidence-card slide-up delay-200">
                    <div class="bg-gray-50/50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                            <i class="far fa-eye text-indigo-900"></i> Visual Evidence
                        </h3>
                        <div class="flex gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-400"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 relative min-h-[400px]">
                        
                        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 hidden md:flex flex-col items-center justify-center w-12 h-12 rounded-full bg-white shadow-lg border border-gray-100">
                            <span class="font-black text-indigo-700 italic text-sm font-serif">VS</span>
                        </div>

                        <div class="p-6 border-b md:border-b-0 md:border-r border-gray-100 relative">
                            <div class="absolute top-4 left-4 z-10 bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-[10px] font-bold border border-purple-200 shadow-sm">
                                REPORTED LOST
                            </div>
                            
                            <div class="w-full h-64 bg-white rounded-xl overflow-hidden relative flex items-center justify-center mb-6 border border-gray-50">
                                <img 
                                    id="lostImage" 
                                    src="" 
                                    class="max-w-full max-h-full object-contain p-2" 
                                    onerror="this.onerror=null; this.src='https://via.placeholder.com/400?text=No+Image'"
                                >
                            </div>

                            <div class="mt-2">
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Item Details</h4>
                                <h3 id="lostTitle" class="text-lg font-bold text-gray-900 skeleton w-3/4 h-7 mb-2">Loading...</h3>
                                <p id="lostDescription" class="text-gray-500 text-sm leading-relaxed skeleton h-16 line-clamp-3">...</p>
                            </div>
                        </div>

                        <div class="p-6 relative bg-gray-50/30">
                            <div class="absolute top-4 right-4 z-10 bg-teal-100 text-teal-700 px-3 py-1 rounded-full text-[10px] font-bold border border-teal-200 shadow-sm">
                                INVENTORY MATCH
                            </div>
                            
                            <div class="w-full h-64 bg-white rounded-xl overflow-hidden relative flex items-center justify-center mb-6 border border-gray-50 shadow-inner">
                                <img 
                                    id="foundImage" 
                                    src="" 
                                    class="max-w-full max-h-full object-contain p-2" 
                                    onerror="this.onerror=null; this.src='https://via.placeholder.com/400?text=No+Image'"
                                >
                            </div>

                            <div class="mt-2">
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Item Details</h4>
                                <h3 id="foundTitle" class="text-lg font-bold text-gray-900 skeleton w-3/4 h-7 mb-2">Loading...</h3>
                                <p id="foundDescription" class="text-gray-500 text-sm leading-relaxed skeleton h-16 line-clamp-3">...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-8 slide-up delay-300">
                    <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-list-ul text-yellow-500"></i> Metadata Comparison
                    </h3>
                    <div class="space-y-2">
                        <div class="grid grid-cols-3 gap-4 px-4 pb-2 text-xs font-bold text-gray-400 uppercase tracking-widest text-center md:text-left">
                            <div>Attribute</div>
                            <div class="text-purple-600">Reported</div>
                            <div class="text-teal-600">Inventory</div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 items-center p-4 rounded-xl bg-gray-50 border border-gray-100">
                            <div class="font-bold text-sm text-gray-500">Brand</div>
                            <div id="lostBrand" class="font-medium text-sm text-gray-900 skeleton">...</div>
                            <div id="foundBrand" class="font-bold text-sm text-gray-900 skeleton">...</div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 items-center p-4 rounded-xl hover:bg-gray-50 border border-transparent hover:border-gray-100 transition-colors">
                            <div class="font-bold text-sm text-gray-500">Color</div>
                            <div id="lostColor" class="font-medium text-sm text-gray-900 skeleton">...</div>
                            <div id="foundColor" class="font-bold text-sm text-gray-900 skeleton">...</div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 items-center p-4 rounded-xl hover:bg-gray-50 border border-transparent hover:border-gray-100 transition-colors">
                            <div class="font-bold text-sm text-gray-500">Location</div>
                            <div id="lostLocation" class="font-medium text-sm text-gray-900 skeleton">...</div>
                            <div id="foundLocation" class="font-bold text-sm text-gray-900 skeleton">...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                
                <div class="glass-panel rounded-2xl p-6 sticky top-6 slide-up delay-300 border-t-4 border-t-yellow-500">
                    <div class="mb-6 pb-6 border-b border-gray-100">
                        <h3 class="font-bold text-xl text-gray-900">Verification Status</h3>
                        <p class="text-sm text-gray-500 mt-1">Real-time system updates</p>
                    </div>

                    <div class="space-y-8 relative pl-2">
                        <div class="absolute left-[19px] top-3 bottom-8 w-0.5 bg-gray-200"></div>

                        <div class="relative flex items-start gap-4 opacity-50 grayscale transition-all duration-500" id="step1">
                            <div class="w-10 h-10 rounded-full bg-white border-2 border-green-500 flex items-center justify-center text-green-500 z-10 shadow-sm flex-shrink-0">
                                <i class="fas fa-file-upload text-sm"></i>
                            </div>
                            <div class="pt-2">
                                <h4 class="font-bold text-gray-800 text-sm">Report Received</h4>
                                <span class="text-xs text-gray-400">Entry logged in DB</span>
                            </div>
                        </div>

                        <div class="relative flex items-start gap-4 opacity-50 grayscale transition-all duration-500" id="step2">
                            <div class="w-10 h-10 rounded-full bg-white border-2 border-yellow-500 flex items-center justify-center text-yellow-600 z-10 shadow-sm flex-shrink-0">
                                <i class="fas fa-brain text-sm"></i>
                            </div>
                            <div class="pt-2">
                                <h4 class="font-bold text-gray-800 text-sm">AI Analysis</h4>
                                <span class="text-xs text-gray-400" id="aiStatusText">Processing vectors...</span>
                            </div>
                        </div>

                        <div class="relative flex items-start gap-4 opacity-50 transition-all duration-500" id="step3">
                            <div class="w-10 h-10 rounded-full bg-white border-2 border-gray-300 flex items-center justify-center text-gray-400 z-10 shadow-sm flex-shrink-0" id="statusIcon">
                                <i class="fas fa-flag text-sm"></i>
                            </div>
                            <div class="pt-2">
                                <h4 class="font-bold text-gray-800 text-sm" id="finalStatusTitle">Pending Decision</h4>
                                <span class="inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 uppercase border border-gray-200" id="statusBadge">WAITING</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 p-5 bg-yellow-50 rounded-xl border border-yellow-100">
                        <div class="flex gap-3">
                            <i class="fas fa-shield-alt text-yellow-600 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-sm text-gray-900">System Confidence</h4>
                                <p class="text-xs text-gray-600 mt-1 leading-relaxed">
                                    The AI has identified significant visual and metadata correlations. Please review the images carefully before claiming.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const matchId = params.get("match_id");
            const token = localStorage.getItem("token");
            
            // --- UI ANIMATION HELPERS ---
            function animateScore(target) {
                const circle = document.getElementById('scoreRing');
                const text = document.getElementById('scoreText');
                const radius = 56;
                const circumference = 2 * Math.PI * radius; // ~351
                const offset = circumference - (target / 100) * circumference;
                
                // Color Logic (Gold Theme)
                let color1 = "#ca8a04"; // Gold
                let color2 = "#eab308"; // Light Gold
                
                if(target > 85) { color1="#16a34a"; color2="#22c55e"; } // Green for very high matches
                else if(target < 50) { color1="#dc2626"; color2="#f87171"; } // Red for low

                // Update Gradient
                const gradient = document.getElementById('gradient');
                gradient.innerHTML = `<stop offset="0%" stop-color="${color2}" /><stop offset="100%" stop-color="${color1}" />`;

                // Animate Ring
                setTimeout(() => {
                    circle.style.strokeDashoffset = offset;
                }, 500);

                // Count Up Number
                let start = 0;
                const duration = 2000;
                const startTime = performance.now();
                
                function update(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // EaseOutExpo
                    const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                    
                    text.innerText = Math.floor(start + (target - start) * ease) + "%";
                    
                    if (progress < 1) requestAnimationFrame(update);
                }
                requestAnimationFrame(update);
            }

            function updateTimeline(status, score) {
                const s1 = document.getElementById('step1');
                const s2 = document.getElementById('step2');
                const s3 = document.getElementById('step3');
                
                // Activate Step 1
                setTimeout(() => { 
                    s1.classList.remove('opacity-50', 'grayscale'); 
                }, 200);

                // Activate Step 2
                setTimeout(() => { 
                    s2.classList.remove('opacity-50', 'grayscale');
                    document.getElementById('aiStatusText').textContent = `Vector Match: ${score}%`;
                }, 800);

                // Activate Step 3
                setTimeout(() => {
                    s3.classList.remove('opacity-50');
                    const iconBox = document.getElementById('statusIcon');
                    const badge = document.getElementById('statusBadge');
                    const title = document.getElementById('finalStatusTitle');
                    const icon = iconBox.querySelector('i');

                    if(status === 'APPROVED' || status === 'RECLAIMED') {
                        iconBox.className = "w-10 h-10 rounded-full bg-green-500 border-2 border-green-600 flex items-center justify-center text-white z-10 shadow-lg shadow-green-500/40 transform scale-110 transition-transform";
                        icon.className = "fas fa-check";
                        title.textContent = status === 'RECLAIMED' ? "Item Claimed" : "Match Verified";
                        badge.className = "inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200";
                        badge.textContent = status;
                    } else if (status === 'REJECTED') {
                        iconBox.className = "w-10 h-10 rounded-full bg-red-500 border-2 border-red-600 flex items-center justify-center text-white z-10 shadow-lg shadow-red-500/40";
                        icon.className = "fas fa-times";
                        title.textContent = "Match Rejected";
                        badge.className = "inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 border border-red-200";
                        badge.textContent = "REJECTED";
                    } else {
                        // Pending
                        iconBox.className = "w-10 h-10 rounded-full bg-white border-2 border-yellow-400 flex items-center justify-center text-yellow-500 z-10 shadow-sm animate-pulse";
                        icon.className = "fas fa-clock";
                    }
                }, 1600);
            }

            // --- DATA LOADING ---
            async function loadData() {
                try {
                    // MOCK DATA for Demo Purposes (Delete in Production)
                    // const match = { match_id: "1024", created_at: new Date(), similarity_score: 0.88, status: "APPROVED", lost: { item_type: "MacBook Pro", brand: "Apple", color: "Space Grey", image_path: "", description: "Left in library", lost_location: "Library" }, found: { item_type: "Laptop", brand: "Apple", color: "Grey", image_path: "", description: "Found on table 4", lost_location: "Central Lib" }};
                    
                    const res = await fetch(`http://127.0.0.1:8000/matches/match/${matchId}`, {
                        headers: { Authorization: "Bearer " + token }
                    });
                    if(!res.ok) throw new Error("API Error");
                    const match = await res.json();
                    
                    const lost = match.lost;
                    const found = match.found;
                    const score = Math.round((match.similarity_score || 0) * 100);

                    // Fill Header
                    document.getElementById('displayMatchId').textContent = match.match_id;
                    document.getElementById('displayMatchId').classList.remove('skeleton');
                    document.getElementById('displayDate').textContent = new Date(match.created_at).toLocaleDateString();
                    document.getElementById('displayDate').classList.remove('skeleton');

                    // Fill Fields
                    const setText = (id, txt) => {
                        const el = document.getElementById(id);
                        if(el) {
                            el.textContent = txt || "--";
                            el.classList.remove('skeleton');
                        }
                    };

                    setText('lostTitle', lost.item_type);
                    setText('lostDescription', lost.description);
                    setText('lostBrand', lost.brand);
                    setText('lostColor', lost.color);
                    setText('lostLocation', lost.lost_location);

                    setText('foundTitle', found.item_type);
                    setText('foundDescription', found.description);
                    setText('foundBrand', found.brand);
                    setText('foundColor', found.color);
                    setText('foundLocation', found.lost_location);

                    // Images Helper
                    const setImg = (id, path) => {
                        const img = document.getElementById(id);
                        const fallback = "https://via.placeholder.com/400?text=No+Image";

                        img.onerror = () => {
                            img.onerror = null; 
                            img.src = fallback;
                        };

                        if(path) {
                            // Ensure URL format
                            const cleanPath = path.startsWith('http') ? path : `http://127.0.0.1:8000/${path}`;
                            img.src = cleanPath;
                        } else {
                            img.src = fallback;
                        }
                    };
                    
                    setImg('lostImage', lost.image_path);
                    setImg('foundImage', found.image_path);

                    // Trigger Animations
                    animateScore(score);
                    updateTimeline(match.status, score);

                } catch (e) {
                    console.error(e);
                }
            }

            if(matchId) loadData();
        });
    </script>
</body>
</html>